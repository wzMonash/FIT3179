{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "data": {"url": "https://raw.githubusercontent.com/wzMonash/FIT3179/refs/heads/main/A2/cleaned_crime_district_year_only.csv"},
  "params": [
    {
      "name": "year_selection",
      "value": 2016,
      "bind": {
        "input": "range",
        "min": 2016,
        "max": 2022,
        "step": 1,
        "name": "Year: "
      }
    },
    {
      "name": "type_selection",
      "value": "all",
      "bind": {
        "input": "select",
        "options": [
          "all",
          "Causing Injury",
          "Murder",
          "Rape",
          "Grouped Armed Robbery",
          "Grouped Unarmed Robbery",
          "Solo Armed Robbery",
          "Solo Unarmed Robbery",
          "Break-in",
          "Theft (Other)",
          "Theft (Lorry)",
          "Theft (Motorcar)",
          "Theft (Motorcycle)"
        ],
        "labels": [
          "All"
        ],
        "name": "Type: "
      }
    }
  ],
  "hconcat": [
    {
      "width": 600,
      "height": 400,
      "title": "Sum of Crimes by State in Malaysia",
      "projection": {"type": "mercator"},
      "layer": [
        {
          "data": {
            "url": "https://raw.githubusercontent.com/wzMonash/FIT3179/refs/heads/main/A2/gadm41_MYS_1.json",
            "format": {"type": "topojson", "feature": "gadm41_MYS_1"}
          },
          "mark": {"type": "geoshape", "stroke": "white"}
        },
        {
          "data": {
            "url": "https://raw.githubusercontent.com/wzMonash/FIT3179/refs/heads/main/A2/cleaned_crime_district_year_only.csv"
          },
          "transform": [
            {
              "calculate": "datum.type == 'causing_injury' ? 'Causing Injury' : datum.type == 'murder' ? 'Murder' : datum.type == 'rape' ? 'Rape' : datum.type == 'robbery_gang_armed' ? 'Grouped Armed Robbery' : datum.type == 'robbery_gang_unarmed' ? 'Grouped Unarmed Robbery' : datum.type == 'robbery_solo_armed' ? 'Solo Armed Robbery' : datum.type == 'robbery_solo_unarmed' ? 'Solo Unarmed Robbery' : datum.type == 'break_in' ? 'Break-in' : datum.type == 'theft_other' ? 'Theft (Other)' : datum.type == 'theft_vehicle_lorry' ? 'Theft (Lorry)' : datum.type == 'theft_vehicle_motorcar' ? 'Theft (Motorcar)' : datum.type == 'theft_vehicle_motorcycle' ? 'Theft (Motorcycle)' : datum.type",
              "as": "crime_type_label"
            },
            {
              "filter": "datum.state != 'Malaysia' && datum.district == 'All' && datum.date == year_selection && datum.crime_type_label == type_selection"
            },
            {
              "aggregate": [{"op": "sum", "field": "crimes", "as": "total_crimes"}],
              "groupby": ["state"]
            },
                        {
              "calculate": "datum.state + datum.date",
              "as": "state_date_key"
            },
            {
              "lookup": "state",
              "from": {
                "data": {"url": "https://raw.githubusercontent.com/wzMonash/FIT3179/refs/heads/main/A2/filtered_population_data.csv"},
                "key": "state",
                "fields": ["population", "date"]
              }
            },
            {
              "calculate": "datum.population > 0 ? (datum.total_crimes / datum.population) : 0",
              "as": "crimes_per_1000"
            },
            {
              "window": [{"op": "rank", "as": "rank"}],
              "sort": [{"field": "crimes_per_1000", "order": "descending"}]
            },
            {
              "lookup": "state",
              "from": {
                "data": {
                  "url": "https://raw.githubusercontent.com/wzMonash/FIT3179/refs/heads/main/A2/gadm41_MYS_1.json",
                  "format": {
                    "type": "topojson",
                    "feature": "gadm41_MYS_1"
                  }
                },
                "key": "properties.NAME_1"
              },
              "as": "geo"
            }
          ],
          "mark": {"type": "geoshape", "stroke": "white"},
          "encoding": {
            "shape": {"field": "geo", "type": "geojson"},
            "color": {
              "field": "crimes_per_1000",
              "type": "quantitative",
              "scale": {"scheme": "blues"},
              "title": "Crimes"
            },
            "tooltip": [
              {"field": "state", "type": "nominal", "title": "State"},
              {"field": "crimes_per_1000", "type": "quantitative", "format": ".2f", "title": "Crimes"},
              {"field": "rank", "type": "quantitative", "title": "Rank"}
            ]
          }
        }
      ],
      "resolve": {"scale": {"color": "independent"}}
    },
    {
      "width": 475,
      "height": 200,
      "mark": {
        "type": "area",
        "line": {"color": "red", "opacity": 0.7},
        "point": true
      },
      "title": "Crimes in Malaysia",
      "transform": [
        {
          "filter": "datum.state == 'Malaysia' && datum.district == 'All' && datum.type != 'all'"
        },
        {
          "calculate": "datum.type == 'causing_injury' ? 'Causing Injury' : datum.type == 'murder' ? 'Murder' : datum.type == 'rape' ? 'Rape' : datum.type == 'robbery_gang_armed' ? 'Grouped Armed Robbery' : datum.type == 'robbery_gang_unarmed' ? 'Grouped Unarmed Robbery' : datum.type == 'robbery_solo_armed' ? 'Solo Armed Robbery' : datum.type == 'robbery_solo_unarmed' ? 'Solo Unarmed Robbery' : datum.type == 'break_in' ? 'Break-in' : datum.type == 'theft_other' ? 'Theft (Other)' : datum.type == 'theft_vehicle_lorry' ? 'Theft (Lorry)' : datum.type == 'theft_vehicle_motorcar' ? 'Theft (Motorcar)' : datum.type == 'theft_vehicle_motorcycle' ? 'Theft (Motorcycle)' : datum.type",
          "as": "crime_type_label"
        },
        {
          "aggregate": [{"op": "sum", "field": "crimes", "as": "total_crimes"}],
          "groupby": ["date", "crime_type_label"]
        }
      ],
      "encoding": {
        "x": {
          "field": "date",
          "type": "ordinal",
          "title": ""
        },
        "y": {
          "field": "total_crimes",
          "type": "quantitative",
          "title": "Total crime"
        },
        "color": {
          "condition": {
            "test": "type_selection == datum.crime_type_label || type_selection == 'all'",
            "field": "crime_type_label",
            "type": "nominal",
            "scale": {"scheme": "set2"},
            "title": "Crime type"
          },
          "value": "lightgray"
        },
        "tooltip": [
          {"field": "date", "type": "ordinal", "title": "Year"},
          {"field": "total_crimes", "type": "quantitative", "title": "Total crimes"},
          {"field": "crime_type_label", "type": "nominal", "title": "Crime type"}
        ]
      }
    }
  ]
}
